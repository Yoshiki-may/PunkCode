# Phase 7-2: 契約登録UI 受入テストチェックリスト

## テスト環境
- [ ] ブラウザ: Chrome/Firefox/Safari
- [ ] dataMode: mock
- [ ] dataMode: supabase（後半テスト）

---

## テスト1: mockモード - 契約追加→一覧表示

### 前提条件
- [ ] dataMode = mock に設定
- [ ] Sales Board にログイン

### 手順
1. [ ] Sales Board → My Clients → 任意のクライアントを選択
2. [ ] クライアント詳細画面で「契約管理」タブをクリック
3. [ ] 「+ 新規契約を追加」ボタンをクリック
4. [ ] ContractModal が表示される
5. [ ] フォームに以下を入力:
   - ステータス: `negotiating`（商談中）
   - 月額料金: `500000`
   - 契約開始日: `2025-01-15`
   - 更新期限日: 空のまま（negotiatingは任意）
   - 契約終了日: 空のまま
6. [ ] 「追加」ボタンをクリック
7. [ ] モーダルが閉じる
8. [ ] 契約管理タブに契約情報カードが表示される
9. [ ] ステータスバッジが「商談中」（青色）で表示される
10. [ ] 月額料金が「¥500,000」で表示される
11. [ ] 契約開始日が「2025/1/15」で表示される

### 期待結果
- [x] 契約が即座に一覧に表示される（楽観的UI更新）
- [x] LocalStorageに保存される
- [x] リロードしても契約が残っている

---

## テスト2: mockモード - KPISummaryが変化

### 前提条件
- [ ] テスト1で追加した契約が存在
- [ ] HomePage（Dashboard）を開いている

### 手順
1. [ ] KPISummaryコンポーネントで「今月の提案件数」を確認（初期値をメモ）
2. [ ] Sales Board → My Clients → 別のクライアントを選択
3. [ ] 契約管理タブで「+ 新規契約を追加」
4. [ ] 以下を入力:
   - ステータス: `negotiating`
   - 月額料金: `300000`
   - 契約開始日: 今月の日付（例: `2024-12-22`）
   - 更新期限日: 空
5. [ ] 「追加」ボタンをクリック
6. [ ] HomePage に戻る
7. [ ] 5〜10秒待つ（autoPull間隔）
8. [ ] KPISummaryで「今月の提案件数」を確認

### 期待結果
- [x] 「今月の提案件数」が +1 増加している
- [x] negotiating契約の件数が正しく集計される

---

## テスト3: mockモード - active契約でKPI変化

### 前提条件
- [ ] HomePage（Dashboard）を開いている

### 手順
1. [ ] KPISummaryで以下をメモ:
   - 今月の受注金額: _______
   - 今月の受注件数: _______
2. [ ] Sales Board → My Clients → クライアントを選択
3. [ ] 契約管理タブで「+ 新規契約を追加」
4. [ ] 以下を入力:
   - ステータス: `active`（アクティブ）
   - 月額料金: `1000000`
   - 契約開始日: 今月の日付（例: `2024-12-22`）
   - **更新期限日: 必須** → 今月の日付（例: `2025-01-15`）
5. [ ] 「追加」ボタンをクリック
6. [ ] HomePage に戻る
7. [ ] 5〜10秒待つ
8. [ ] KPISummaryを確認

### 期待結果
- [x] 「今月の受注金額」が +¥1,000,000 増加
- [x] 「今月の受注件数」が +1 増加
- [x] active契約が正しく集計される

---

## テスト4: mockモード - contractRenewalアラート

### 前提条件
- [ ] QAパネル（Ctrl+Shift+D）を開く
- [ ] 「契約更新閾値（日）」を `30` に設定

### 手順
1. [ ] Sales Board → AlertsWidget を確認
2. [ ] 「契約更新期限」のカウントをメモ: _______
3. [ ] Sales Board → My Clients → クライアントを選択
4. [ ] 契約管理タブで「+ 新規契約を追加」
5. [ ] 以下を入力:
   - ステータス: `active`
   - 月額料金: `500000`
   - 契約開始日: 今月の日付
   - **更新期限日: 今日から7日後**（例: `2024-12-29`）
6. [ ] 「追加」ボタンをクリック
7. [ ] Sales Board に戻る
8. [ ] 5〜10秒待つ
9. [ ] AlertsWidgetの「契約更新期限」カウントを確認

### 期待結果
- [x] 「契約更新期限」カウントが +1 増加
- [x] renewalDateが30日以内の契約が正しく検出される

---

## テスト5: mockモード - 契約編集

### 前提条件
- [ ] 既存の契約が存在

### 手順
1. [ ] Sales Board → My Clients → 契約のあるクライアントを選択
2. [ ] 契約管理タブを開く
3. [ ] 「編集」ボタンをクリック
4. [ ] ContractModalが既存データで開く
5. [ ] 以下を変更:
   - ステータス: `negotiating` → `active`
   - 更新期限日: 今日から10日後を設定
6. [ ] 「更新」ボタンをクリック
7. [ ] モーダルが閉じる
8. [ ] 契約管理タブで変更が反映されていることを確認

### 期待結果
- [x] 契約が正しく更新される
- [x] ステータスバッジが「アクティブ」（緑色）に変化
- [x] 更新期限日が表示される
- [x] KPISummaryが更新される（negotiating → active）

---

## テスト6: mockモード - バリデーション

### 手順A: startDate必須チェック
1. [ ] 契約追加モーダルを開く
2. [ ] startDateを空のまま「追加」ボタンをクリック
3. [ ] エラーメッセージ「契約開始日は必須です」が表示される
4. [ ] 保存されない（モーダルが閉じない）

### 手順B: monthlyFee 0以上チェック
1. [ ] 契約追加モーダルを開く
2. [ ] monthlyFeeに `-5000` を入力
3. [ ] 「追加」ボタンをクリック
4. [ ] エラーメッセージ「月額料金は0以上である必要があります」が表示される
5. [ ] 保存されない

### 手順C: active時のrenewaldDate必須チェック
1. [ ] 契約追加モーダルを開く
2. [ ] ステータス: `active`
3. [ ] startDate: 今日の日付
4. [ ] monthlyFee: `100000`
5. [ ] renewalDate: 空のまま
6. [ ] 「追加」ボタンをクリック
7. [ ] エラーメッセージ「アクティブ契約の場合、更新期限日は必須です」が表示される
8. [ ] 保存されない

### 期待結果
- [x] 全てのバリデーションが正しく機能する
- [x] エラー時は保存されず、ユーザーにフィードバックが表示される

---

## テスト7: supabaseモード - 2ブラウザ同期

### 前提条件
- [ ] dataMode = supabase に設定
- [ ] Supabase接続済み
- [ ] ブラウザA: Sales role でログイン
- [ ] ブラウザB: Direction role でログイン

### 手順
1. [ ] ブラウザA（Sales）で契約追加:
   - クライアント: 同じクライアントを選択
   - ステータス: `active`
   - 月額料金: `800000`
   - 契約開始日: 今日
   - 更新期限日: 今日から5日後
2. [ ] 「追加」ボタンをクリック
3. [ ] ブラウザAで契約が即座に表示されることを確認
4. [ ] 5〜10秒待つ（autoPull間隔）
5. [ ] ブラウザB（Direction）で同じクライアントの契約管理タブを開く
6. [ ] ブラウザBで契約情報が表示されることを確認

### 期待結果
- [x] ブラウザAで追加した契約がブラウザBに自動反映される
- [x] autoPullが正しく動作する
- [x] SSOT（Supabaseが真のデータソース）が成立

---

## テスト8: supabaseモード - KPI同期

### 前提条件
- [ ] ブラウザA: Sales role
- [ ] ブラウザB: Direction role

### 手順
1. [ ] ブラウザB（Direction）でHomePageを開く
2. [ ] KPISummaryで「今月の受注金額」をメモ: _______
3. [ ] ブラウザA（Sales）で契約追加:
   - ステータス: `active`
   - 月額料金: `2000000`
   - 契約開始日: 今月の日付
   - 更新期限日: 今日から15日後
4. [ ] 10〜15秒待つ
5. [ ] ブラウザB（Direction）のKPISummaryをチェック

### 期待結果
- [x] ブラウザBの「今月の受注金額」が +¥2,000,000 増加
- [x] KPIがブラウザ間で同期される

---

## テスト9: supabaseモード - AlertsWidget同期

### 前提条件
- [ ] ブラウザA: Sales role
- [ ] ブラウザB: Direction role
- [ ] QAパネルで「契約更新閾値（日）」= `30`

### 手順
1. [ ] ブラウザB（Direction）でSales Boardを開く
2. [ ] AlertsWidgetで「契約更新期限」カウントをメモ: _______
3. [ ] ブラウザA（Sales）で契約追加:
   - ステータス: `active`
   - 月額料金: `600000`
   - 契約開始日: 今日
   - 更新期限日: **今日から3日後**
4. [ ] 10〜15秒待つ
5. [ ] ブラウザB（Direction）のAlertsWidgetをチェック

### 期待結果
- [x] ブラウザBの「契約更新期限」カウントが +1 増加
- [x] アラートがブラウザ間で同期される

---

## テスト10: supabaseモード - Outbox統合

### 前提条件
- [ ] dataMode = supabase
- [ ] ネットワーク接続あり

### 手順A: 成功ケース
1. [ ] Sales Board → My Clients → クライアント選択 → 契約管理タブ
2. [ ] 契約を追加
3. [ ] QAパネル（Ctrl+Shift+D）→ Outboxタブを開く
4. [ ] `contract.create` のエントリを探す
5. [ ] statusを確認

### 期待結果（成功時）
- [x] outboxに `contract.create` が一時的に `pending` で記録される
- [x] 送信成功後、statusが `sent` に変わる（または自動削除）

### 手順B: 失敗ケース（ネットワーク切断）
1. [ ] ブラウザの開発者ツールでネットワークをオフライン化
2. [ ] 契約を追加
3. [ ] QAパネル → Outboxタブを開く
4. [ ] `contract.create` のエントリを確認

### 期待結果（失敗時）
- [x] outboxに `contract.create` が `pending` または `failed` で記録される
- [x] 「Retry All」ボタンで再送可能
- [x] ネットワーク復旧後、Retry Allで送信成功

---

## テスト11: RLS - Client role制限

### 前提条件
- [ ] dataMode = supabase
- [ ] ブラウザC: Client role でログイン
- [ ] Client roleは自社client_idのみ読み書き可能と想定

### 手順
1. [ ] ブラウザC（Client）でログイン
2. [ ] My Clients → 自社のクライアントを選択
3. [ ] 契約管理タブを開く
4. [ ] 契約を追加（自社client_id）
5. [ ] 保存成功を確認
6. [ ] My Clients → **他社のクライアント**を選択（可能な場合）
7. [ ] 契約管理タブで契約を追加しようとする
8. [ ] QAパネル → Outboxタブを確認

### 期待結果
- [x] 自社client_idの契約は追加成功
- [x] 他社client_idの契約追加はRLSで拒否される
- [x] 拒否時、outboxに `failed` で記録される
- [x] QAパネルでエラーが可視化される

---

## テスト12: UI変更ゼロの確認

### 確認項目

#### DirectionClientDetail
- [ ] 既存タブ（Dashboard/BasicInfo/Progress等）のレイアウトが変わっていない
- [ ] 「契約管理」タブが3番目（基本情報の次）に追加されている
- [ ] 他タブの色/余白/フォントが変わっていない
- [ ] タブ切り替えが正常に動作する

#### KPISummary
- [ ] 見た目が変わっていない
- [ ] 既存のデザイン（カード/色/フォント）が維持されている
- [ ] 契約追加で値が動的に更新される

#### AlertsWidget
- [ ] 見た目が変わっていない
- [ ] 既存のアラートアイテムが変わっていない
- [ ] 契約更新期限アラートが正しく動作する

#### ContractModal
- [ ] 既存のデザインシステムに準拠している
- [ ] PALSSテーマ（PALSS MODE/DARK/FEMININE）で正しく表示される
- [ ] モーダルが中央に配置される
- [ ] ESCキーで閉じられる（任意）

### 期待結果
- [x] 既存UIの見た目が一切変わっていない
- [x] 追加UIはモーダル/タブで非破壊的に実装されている
- [x] デザインシステムが統一されている

---

## 総合評価

### 必須機能チェック
- [ ] A) 契約一覧（クライアント単位）が表示される
- [ ] B) 契約の新規登録（モーダル）が動作する
- [ ] C) 契約更新が動作する
- [ ] D) KPISummaryが実データで更新される
- [ ] D) AlertsWidget（contractRenewal）が実データで更新される

### データ層チェック
- [ ] getAllContracts() / getActiveContracts() が使用される
- [ ] addContract() / updateContract() が使用される
- [ ] outbox統合が動作する
- [ ] autoPullが動作する
- [ ] RLSが適用される

### バリデーションチェック
- [ ] monthlyFee ≥ 0
- [ ] startDate必須
- [ ] status必須
- [ ] active時のrenewaldDate必須

### 非破壊性チェック
- [ ] 既存UIの見た目が変わっていない
- [ ] 追加UIはモーダル/タブで実装
- [ ] デザインシステムが統一されている

---

## テスト完了署名

**テスト実施者**: _______________________  
**テスト日**: _______________________  
**Phase**: 7-2  
**Status**: [ ] PASS / [ ] FAIL  
**備考**:

---

## 不具合報告（もしあれば）

| # | 不具合内容 | 再現手順 | 優先度 | 状態 |
|---|-----------|---------|--------|------|
| 1 |           |         |        |      |
| 2 |           |         |        |      |
| 3 |           |         |        |      |

---

## 改善提案（もしあれば）

| # | 改善内容 | 理由 | 優先度 |
|---|---------|------|--------|
| 1 |         |      |        |
| 2 |         |      |        |
| 3 |         |      |        |

